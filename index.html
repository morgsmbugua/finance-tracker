<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Household Finance Tracker:&copy;morgsmbugua</title>
  <style>
    :root { 
      --primary-blue: #0056b3; 
      --deep-black: #121212; 
      --pure-white: #ffffff;
      --income-green: #2ecc71; 
      --expense-red: #e74c3c; 
    }
    * {
        scroll-behavior: smooth;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    body { 
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
      background-color: #151515; 
      color: var(--pure-white); 
      margin: 0; 
      padding: 10px; 
      display: flex; 
      justify-content: center; 
    }

    .container { 
      width: 100%;
      background: #15151524; 
      padding: 25px; 
      border-radius: 5px; 
      box-shadow: 0.1px 0.1px 4px rgb(255, 255, 255);
      border: 1px solid #333;
    }

    h2 { 
        text-align: center; 
        color: azure; 
        letter-spacing: 5px; 
        margin-top: 0; 
        font-weight: 300; 
    }
    
    .hp-container { 
        margin-bottom: 25px; 
    }
    .hp-label { 
        display: flex; 
        justify-content: space-between; 
        margin-bottom: 8px; 
        font-size: 12px; 
        font-weight: 500; 
        color: #aaa; 
    }
    .hp-bar-bg { 
        width: 100%; 
        height: 5px; 
        background: #575757bb; 
        border-radius: 2px; 
        overflow: hidden; 
    }
    .hp-fill { 
        height: 100%; 
        width: 100%; 
        transition: width 0.6s ease; 
        background: var(--primary-blue); 
    }

    .balance-section { 
        text-align: center; 
        margin-bottom: 25px; 
        background-color: #222; 
        padding: 15px; 
        border-radius: 5px; 
    }
    .balance-section small { 
        color: #ffffffb7; 
        text-transform: uppercase; 
        font-size: 13px; 
        letter-spacing: 5px; 
    }
    .balance-section h1 { 
        margin: 5px 0 0 0; 
        color: var(--pure-white); 
        font-size: 32px; 
    }

    .stat-grid { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 15px; 
        margin-bottom: 25px; 
    }
    .stat-card { 
        padding: 12px; 
        border-radius: 5px; 
        text-align: center; 
        background: var(--pure-white); 
        color: var(--deep-black); 
    }
    .stat-card small { 
        display: block; 
        font-size: 10px; 
        margin-bottom: 4px; 
        opacity: 0.7; 
        font-weight: 750; 
    }
    .stat-card span { 
        font-size: 16px; 
        font-weight: 800; 
    }

    .section-title { 
        font-size: 13px; 
        font-weight: 650; 
        text-align: center;
        text-transform: uppercase; 
        margin: 25px 0 12px; 
        color: var(--primary-blue);
        padding-left: 10px; 
    }
    .input-row { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 10px; 
        background: #3232327c; 
        padding: 10px 15px; 
        border-radius: 5px; 
    }
    .input-row input { 
        width: 120px; 
        padding: 8px; 
        border-radius: 3px; 
        border: 1px solid #444; 
        background: var(--pure-white); 
        color: var(--deep-black); 
        text-align: right; 
        font-weight: 650; 
        outline: none; 
    }

    /* HISTORY STYLES */
    .history-header { 
        display: grid; 
        grid-template-columns: 1.2fr 1fr 1fr 1fr 0.4fr; 
        font-size: 10px; 
        color: #b5b5b5; 
        font-weight: 500; 
        padding: 0 10px 5px; 
        text-transform: uppercase; 
    }
    .history-list { 
        max-height: 400px; 
        overflow-y: auto; 
        background: rgba(0, 0, 0, 0.652); 
        border-radius: 5px; 
        padding: 5px; 
        font-weight: 500;
    }
    
    .day-group { 
        border-bottom: 1px solid #3c3c3c; 
    }
    .history-summary-row { 
        display: grid; 
        grid-template-columns: 1.2fr 1fr 1fr 1fr 0.4fr; 
        align-items: center; 
        font-size: 11px; 
        font-weight: 500;
        padding: 12px 5px; 
        cursor: pointer; 
    }
    
    .day-details { 
        background: #151515; 
        padding: 0 10px; 
        display: none; 
        overflow: hidden; 
        border-radius: 8px; 
        margin: 0 5px 10px; 
    }
    .detail-item { 
        display: flex; 
        justify-content: space-between; 
        padding: 6px 0; 
        font-size: 10px; 
        border-bottom: 1px solid #222; 
    }
    .detail-item:last-child { 
        border-bottom: none; 
    }
    .detail-label { 
        color: #aaa; 
    }
    .detail-amt { 
        font-weight: 500; 
    }

    .full-btn { 
        width: 100%; 
        margin: 20px 0; 
        padding: 15px; 
        border-radius: 5px; 
        border: none; 
        font-weight: 500; 
        cursor: pointer; 
        background: var(--primary-blue); 
        color: var(--pure-white); 
        text-transform: uppercase; 
    }
    .footer-btns { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 10px; 
    }
    .reset-btn { 
        background: transparent; 
        color: #ffffff; 
        border: 0.1px  solid #ffffff; 
        padding: 12px; 
        border-radius: 5px; 
        cursor: pointer; 
        font-size: 11px; 
        font-weight: 500; 
        text-transform: uppercase; 
    }
    .xls-btn { 
        background: var(--pure-white); 
        color: var(--deep-black); 
        padding: 12px; 
        border-radius: 5px; 
        cursor: pointer; 
        font-size: 11px; 
        font-weight: 500; 
        text-transform: uppercase; 
        border: none; 
    }
    
    .action-btn { 
        background: none; 
        border: none; color: #ffffff; 
        cursor: pointer; 
        font-size: 15px; 
    }
    .editing-mode { 
        background: var(--primary-blue); 
        color: white; 
        padding: 10px; 
        border-radius: 10px; 
        text-align: center; 
        margin-bottom: 20px; 
        font-size: 12px; 
        font-weight: 500; 
    }
  </style>
  <link rel="icon" href="images/bob.png">
</head>
<body>

<div class="container">
  <h2>HOUSEHOLD TRACKER</h2>
  
  <div id="edit-indicator" style="display:none;" class="editing-mode">✏️ UPDATING RECORD FOR: <span id="edit-date-label"></span></div>

  <div class="hp-container">
    <div class="hp-label">
        <span>BUDGET HEALTH</span>
        <span id="hp-percent">100%</span>
    </div>
    <div class="hp-bar-bg">
        <div id="hp-fill" class="hp-fill"></div>
    </div>
  </div>

  <div class="balance-section">
    <small>Current Balance</small>
    <h1 id="balance">Ksh 0</h1>
  </div>

  <div class="stat-grid">
    <div class="stat-card">
        <small>INCOME</small>
        <span id="inc-total" style="color:var(--income-green)">0</span>
    </div>
    <div class="stat-card">
        <small>EXPENSE</small>
        <span id="exp-total" style="color:var(--expense-red)">0</span>
    </div>
  </div>

  <div class="section-title">Income Sources</div>
  <div class="input-row">
    <span>Income</span> 
    <input type="number" class="inc-input" data-label="Monthly Income" id="f-income" placeholder="0">
</div>
  <div class="input-row">
    <span>Debt (Received)</span> 
    <input type="number" class="inc-input" data-label="Debt Received" id="f-inc-debt" placeholder="0">
</div>
  <div class="input-row"
  <span>Other</span> 
  <input type="number" class="inc-input" data-label="Other Income" id="f-inc-other" placeholder="0">
</div>

  <div class="section-title">Monthly Expenses</div>
  <div class="input-row"><span>Rent</span> <input type="number" class="exp-input" data-label="Rent" id="f-rent" placeholder="0"></div>
  <div class="input-row"><span>Food</span> <input type="number" class="exp-input" data-label="Food" id="f-food" placeholder="0"></div>
  <div class="input-row"><span>Transport</span> <input type="number" class="exp-input" data-label="Transport" id="f-trans" placeholder="0"></div>
  <div class="input-row"><span>School Fees</span> <input type="number" class="exp-input" data-label="School Fees" id="f-fees" placeholder="0"></div>
  <div class="input-row"><span>Debt (Repay)</span> <input type="number" class="exp-input" data-label="Debt Repayment" id="f-exp-debt" placeholder="0"></div>
  <div class="input-row"><span>Electricity</span> <input type="number" class="exp-input" data-label="Electricity" id="f-elec" placeholder="0"></div>
  <div class="input-row"><span>Gas</span> <input type="number" class="exp-input" data-label="Gas" id="f-gas" placeholder="0"></div>
  <div class="input-row"><span>Wifi</span> <input type="number" class="exp-input" data-label="Wifi" id="f-wifi" placeholder="0"></div>
  <div class="input-row"><span>Extra Bills</span> <input type="number" class="exp-input" data-label="Extra Bills" id="f-extra" placeholder="0"></div>

  <button class="full-btn" id="save-btn" onclick="saveToHistory()">SAVE</button>

  <div class="section-title">History Ramp</div>
  <div class="history-header">
    <span>Date</span>
    <span>In</span>
    <span>Out</span>
    <span>Bal</span>
    <span></span>
</div>
  <div class="history-list" id="history-log"></div>

  <div style="margin-top: 30px;" class="footer-btns">
      <button onclick="hardReset()" class="reset-btn">Reset All</button>
      <button onclick="exportToExcel()" class="xls-btn">Export for Excel</button>
  </div>
</div>

<script>
  let txLogs = JSON.parse(localStorage.getItem('hh_final_data_v5')) || [];
  let currentlyEditingDate = null;

  function init() {
    document.querySelectorAll('input').forEach(i => i.addEventListener('input', runCalc));
    renderHist();
    runCalc();
  }

  function runCalc() {
    let inc = 0, exp = 0;
    document.querySelectorAll('.inc-input').forEach(i => inc += parseFloat(i.value)||0);
    document.querySelectorAll('.exp-input').forEach(i => exp += parseFloat(i.value)||0);
    const bal = inc - exp;
    document.getElementById('inc-total').innerText = inc.toLocaleString();
    document.getElementById('exp-total').innerText = exp.toLocaleString();
    document.getElementById('balance').innerText = `Ksh ${bal.toLocaleString()}`;
    let hp = inc > 0 ? (bal / inc) * 100 : (exp > 0 ? 0 : 100);
    const fill = document.getElementById('hp-fill');
    fill.style.width = Math.max(0, Math.min(100, hp)) + "%";
    fill.style.background = hp > 50 ? "var(--income-green)" : (hp > 20 ? "#f1c40f" : "var(--expense-red)");
    document.getElementById('hp-percent').innerText = Math.round(hp) + "%";
  }

  function saveToHistory() {
    const date = currentlyEditingDate || new Date().toLocaleDateString('en-GB');
    txLogs = txLogs.filter(log => log.date !== date);
    document.querySelectorAll('input').forEach(i => {
      const val = parseFloat(i.value) || 0;
      if (val !== 0) {
        txLogs.push({ date, category: i.getAttribute('data-label'), type: i.classList.contains('inc-input') ? 'Income' : 'Expense', amount: val, fieldId: i.id });
      }
    });
    localStorage.setItem('hh_final_data_v5', JSON.stringify(txLogs));
    currentlyEditingDate = null;
    document.getElementById('edit-indicator').style.display = 'none';
    document.getElementById('save-btn').innerText = "Saved to Dashboard";
    document.querySelectorAll('input').forEach(i => i.value = '');
    renderHist();
    runCalc();
  }

  function toggleDetails(date) {
    const el = document.getElementById(`details-${date.replace(/\//g, '-')}`);
    el.style.display = (el.style.display === 'block') ? 'none' : 'block';
  }

  function editDay(e, date) {
    e.stopPropagation(); // Prevents toggleDetails from firing
    const dailyLogs = txLogs.filter(log => log.date === date);
    currentlyEditingDate = date;
    document.getElementById('edit-date-label').innerText = date;
    document.getElementById('edit-indicator').style.display = 'block';
    document.getElementById('save-btn').innerText = "Update Saved Record";
    document.querySelectorAll('input').forEach(i => i.value = ''); 
    dailyLogs.forEach(log => {
      const el = document.getElementById(log.fieldId);
      if (el) el.value = log.amount;
    });
    window.scrollTo({ top: 0, behavior: 'smooth' });
    runCalc();
  }

  function renderHist() {
    const logContainer = document.getElementById('history-log');
    logContainer.innerHTML = txLogs.length ? '' : '<div style="text-align:center; padding:15px; color:#555;">No records</div>';
    
    const grouped = txLogs.reduce((acc, log) => {
      if (!acc[log.date]) acc[log.date] = { inc: 0, exp: 0, items: [] };
      if (log.type === 'Income') acc[log.date].inc += log.amount;
      else acc[log.date].exp += log.amount;
      acc[log.date].items.push(log);
      return acc;
    }, {});

    Object.keys(grouped).sort((a,b) => b.split('/').reverse().join('').localeCompare(a.split('/').reverse().join(''))).forEach(date => {
      const h = grouped[date];
      const dateId = date.replace(/\//g, '-');
      
      let detailHtml = h.items.map(item => `
        <div class="detail-item">
          <span class="detail-label">${item.category}</span>
          <span class="detail-amt" style="color:${item.type==='Income'?'var(--income-green)':'var(--expense-red)'}">${item.amount.toLocaleString()}</span>
        </div>
      `).join('');

      logContainer.innerHTML += `
        <div class="day-group">
          <div class="history-summary-row" onclick="toggleDetails('${date}')">
            <span style="color:#888">${date}</span>
            <span style="color:var(--income-green)">${h.inc.toLocaleString()}</span>
            <span style="color:var(--expense-red)">${h.exp.toLocaleString()}</span>
            <span style="font-weight:500">${(h.inc - h.exp).toLocaleString()}</span>
            <button class="action-btn" onclick="editDay(event, '${date}')">✎</button>
          </div>
          <div class="day-details" id="details-${dateId}">
            <div style="font-size:10px; color:#555; margin-bottom:5px; text-transform:uppercase;">Daily Breakdown</div>
            ${detailHtml}
          </div>
        </div>`;
    });
  }

  function exportToExcel() {
    let csvContent = "Date,Item Category,Type,Amount (Ksh)\n";
    txLogs.forEach(log => { csvContent += `${log.date},"${log.category}",${log.type},${log.amount}\n`; });
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'Detailed_Household_Report.csv';
    link.click();
  }

  function hardReset() { if(confirm("Permanently Erase All Data?")) { localStorage.clear(); location.reload(); } }
  init();
</script>
</body>
</html>