<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Finance Tracker:&copy;morgsmbugua</title>
  <style>
    :root { 
      --primary-blue: #0056b3; 
      --deep-black: #121212; 
      --pure-white: #ffffff;
      --income-green: #2ecc71; 
      --expense-red: #e74c3c; 
      --soft-gray: #f8f9fa;
    }
    * {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    
    body { 
      font-family:system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
      background-color: var(--deep-black); 
      color: var(--pure-white); 
      margin: 0; 
      padding: 10px; 
      display: flex; 
      justify-content: center; 
    }

    .container { 
      width: 100%; 
      max-width: 460px; 
      background: #1e1e1e; 
      padding: 25px; 
      border-radius: 5px; 
      box-shadow: 1px 1px 20px rgba(255, 255, 255, 0.5);
      border: 1px solid #333;
    }

    h2 { 
        text-align: center; 
        color: var(--pure-white); 
        letter-spacing: 1px; 
        margin-top: 0; 
        font-weight: 300; 
    }
    
    /* Progress Bar */
    .hp-container { 
        margin-bottom: 25px; 
    }
    .hp-label { 
        display: flex; 
        justify-content: space-between; 
        margin-bottom: 8px; 
        font-size: 12px; 
        font-weight: bold; 
        color: #aaa; 
    }
    .hp-bar-bg { 
        width: 100%; 
        height: 7px; 
        background: #333; 
        border-radius: 2px; 
        overflow: hidden; 
    }
    .hp-fill { 
        height: 100%; 
        width: 100%; 
        transition: width 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        background: var(--primary-blue); 
    }

    /* Totals Dashboard */
    .balance-section { 
        text-align: center; 
        margin-bottom: 25px; 
        background: rgba(255, 255, 255, 0.03); 
        padding: 15px; 
        border-radius: 5px; 
    }
    .balance-section small { 
        color: #888; 
        text-transform: uppercase; 
        font-size: 15px; 
        letter-spacing: 5px; 
    }
    .balance-section h1 { 
        margin: 5px 0 0 0; 
        color: var(--pure-white); 
        font-size: 32px; 
    }

    .stat-grid { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 15px; 
        margin-bottom: 25px; 
    }
    .stat-card { 
        padding: 12px; 
        border-radius: 5px; 
        text-align: center; 
        background: var(--pure-white); 
        color: var(--deep-black); 
    }
    .stat-card small { 
        display: block; 
        font-size: 10px; 
        margin-bottom: 4px; 
        opacity: 0.7; 
        font-weight: bold; 
    }
    .stat-card span { 
        font-size: 16px; 
        font-weight: 900; 
    }

    /* Inputs */
    .section-title { 
        font-size: 18px; 
        font-weight: bold; 
        text-align: center;
        text-transform: uppercase; 
        margin: 25px 0 12px; 
        color:#005effb9; 
        padding-left: 10px; 
    }
    .input-row { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 10px; 
        background: rgba(255,255,255,0.05); 
        padding: 10px 15px; 
        border-radius: 5px; 
        transition: 0.3s; 
    }
    .input-row:hover { 
        background: rgba(255,255,255,0.08); 
    }
    .input-row span { 
        font-size: 14px; 
        color: #ffffff; 
    }
    .input-row input { 
        width: 110px; 
        padding: 8px; 
        border-radius: 6px; 
        border: 1px solid #ffffff; 
        background: var(--pure-white); 
        color:#121212; 
        text-align: right; 
        font-weight: bold; 
    }
    .input-row input:focus { 
        border-color: var(--primary-blue); 
        outline: none; 
    }

    /* History Table */
    .history-header { 
        display: grid; 
        grid-template-columns: 1.5fr 1fr 1fr 1fr 0.5fr; 
        font-size: 10px; 
        color: #b2b2b2; 
        font-weight: bold; 
        padding: 0 10px 5px; 
        text-transform: uppercase; 
    }
    .history-list { 
        max-height: 250px; 
        overflow-y: auto; 
        background: rgba(0,0,0,0.3); 
        border-radius: 5px; 
        padding: 5px; 
    }
    .history-item { 
        display: grid; 
        grid-template-columns: 1.5fr 1fr 1fr 1fr 0.5fr; 
        align-items: center; 
        font-size: 11px; 
        padding: 12px 5px; 
        border-bottom: 1px solid #222; 
    }
    .history-item span { 
        overflow: hidden; 
        text-overflow: ellipsis; 
        white-space: nowrap; 
    }

    /* Buttons */
    .full-btn { 
        width: 100%; 
        margin: 20px 0; 
        padding: 15px; 
        border-radius: 12px; 
        border: none; 
        font-weight: bold; 
        cursor: pointer; 
        background: var(--primary-blue); 
        color: var(--pure-white); 
        transition: 0.3s; text-transform: uppercase; 
    }
    .full-btn:hover { 
        background: #1984ff; 
        transform: translateY(-2px); 
    }
    
    .footer-btns { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 10px; 
    }
    button { 
        padding: 12px; 
        border-radius: 5px; 
        border: none; 
        font-weight: bold; 
        cursor: pointer; 
        font-size: 11px; 
        text-transform: uppercase; 
    }
    .reset-btn { 
        background: transparent; 
        color: #ffffff; 
        border: 1px solid #ffffff; 
    }
    .csv-btn { 
        background: var(--pure-white); 
        color: var(--deep-black); 
    }
    
    .action-btn { 
        background: none; 
        border: none; 
        color: #555; 
        cursor: pointer; 
        font-size: 14px; 
        padding: 0 5px; 
    }
    .edit-btn:hover { 
        color: var(--primary-blue); 
    }
    .del-btn:hover { 
        color: var(--expense-red); 
    }

    .editing-mode { 
        background: var(--primary-blue); 
        color: white; 
        padding: 10px; 
        border-radius: 10px; 
        text-align: center; 
        margin-bottom: 20px; 
        font-size: 12px; 
        font-weight: bold; 
        animation: pulse 2s infinite; 
    }
    @keyframes pulse { 
        0% { opacity: 1; } 
        50% { opacity: 0.7; } 
        100% { opacity: 1; } 
    }
  </style>
  <link rel="icon" href="/images/bob.png">
</head>
<body>

<div class="container">
  <h2>FINANCE LOG</h2>
  
  <div id="edit-indicator" style="display:none;" class="editing-mode">✏️ UPDATING RECORD FOR: <span id="edit-date-label"></span></div>

  <div class="hp-container">
    <div class="hp-label">
        <span>CASH FLOW HEALTH</span>
        <span id="hp-percent">100%</span>
    </div>
    <div class="hp-bar-bg">
        <div id="hp-fill" class="hp-fill"></div>
    </div>
  </div>

  <div class="balance-section">
    <small>Current Balance</small>
    <h1 id="balance">Ksh 0</h1>
  </div>

  <div class="stat-grid">
    <div class="stat-card">
        <small>INCOME</small>
        <span id="inc-total" style="color:var(--income-green)">0</span>
    </div>
    <div class="stat-card">
        <small>EXPENSE</small>
        <span id="exp-total" style="color:var(--expense-red)">0</span>
    </div>
  </div>

  <div class="section-title">Income Sources</div>
  <div class="input-row">
    <span>Income</span>
    <input type="number" class="inc-input" id="f-income" placeholder="0"></div>
  <div class="input-row"><span>Debt Received</span> <input type="number" class="inc-input" id="f-inc-debt" placeholder="0"></div>
  <div class="input-row"><span>Other</span> <input type="number" class="inc-input" id="f-inc-other" placeholder="0"></div>

  <div class="section-title">Household Expenses</div>
  <div class="input-row"><span>Rent</span> <input type="number" class="exp-input" id="f-rent" placeholder="0"></div>
  <div class="input-row"><span>Food</span> <input type="number" class="exp-input" id="f-food" placeholder="0"></div>
  <div class="input-row"><span>Transport</span> <input type="number" class="exp-input" id="f-trans" placeholder="0"></div>
  <div class="input-row"><span>School Fees</span> <input type="number" class="exp-input" id="f-fees" placeholder="0"></div>
  <div class="input-row"><span>Debt Repayment</span> <input type="number" class="exp-input" id="f-exp-debt" placeholder="0"></div>
  <div class="input-row"><span>Electricity</span> <input type="number" class="exp-input" id="f-elec" placeholder="0"></div>
  <div class="input-row"><span>Gas</span> <input type="number" class="exp-input" id="f-gas" placeholder="0"></div>
  <div class="input-row"><span>Wifi</span> <input type="number" class="exp-input" id="f-wifi" placeholder="0"></div>
  <div class="input-row"><span>Extra Bills</span> <input type="number" class="exp-input" id="f-extra" placeholder="0"></div>

  <button class="full-btn" id="save-btn" onclick="saveToHistory()">SAVE</button>

  <div class="section-title" style="border-color: #555;">History Log</div>
  <div class="history-header">
    <span>Date</span>
    <span>In</span>
    <span>Out</span>
    <span>Bal</span>
    <span></span>
  </div>
  <div class="history-list" id="history-log"></div>

  <div style="margin-top: 30px;" class="footer-btns">
      <button onclick="shareData()" class="csv-btn">Export & Share</button>
      <button onclick="hardReset()" class="reset-btn">Reset All</button>
  </div>
</div>

<script>
  let history = JSON.parse(localStorage.getItem('hh_fin_v2')) || [];
  let currentlyEditingDate = null;

  function init() {
    document.querySelectorAll('input').forEach(i => i.addEventListener('input', runCalc));
    renderHist();
    runCalc();
  }

  function runCalc() {
    let inc = 0, exp = 0;
    document.querySelectorAll('.inc-input').forEach(i => inc += parseFloat(i.value)||0);
    document.querySelectorAll('.exp-input').forEach(i => exp += parseFloat(i.value)||0);
    const bal = inc - exp;

    document.getElementById('inc-total').innerText = inc.toLocaleString();
    document.getElementById('exp-total').innerText = exp.toLocaleString();
    document.getElementById('balance').innerText = `Ksh ${bal.toLocaleString()}`;
    
    let hp = inc > 0 ? (bal / inc) * 100 : (exp > 0 ? 0 : 100);
    hp = Math.max(0, Math.min(100, hp));
    const fill = document.getElementById('hp-fill');
    fill.style.width = hp + "%";
    fill.style.background = hp > 50 ? "var(--income-green)" : (hp > 20 ? "#f1c40f" : "var(--expense-red)");
    document.getElementById('hp-percent').innerText = Math.round(hp) + "%";
  }

  function saveToHistory() {
    const date = currentlyEditingDate || new Date().toLocaleDateString('en-GB');
    let dataMap = {};
    document.querySelectorAll('input').forEach(i => dataMap[i.id] = i.value);

    let inc = 0, exp = 0;
    document.querySelectorAll('.inc-input').forEach(i => inc += parseFloat(i.value)||0);
    document.querySelectorAll('.exp-input').forEach(i => exp += parseFloat(i.value)||0);

    history = history.filter(h => h.date !== date);
    history.push({ date, inc, exp, bal: inc - exp, details: dataMap });
    localStorage.setItem('hh_fin_v2', JSON.stringify(history));
    
    cancelEdit();
    renderHist();
    runCalc();
  }

  function cancelEdit() {
    currentlyEditingDate = null;
    document.getElementById('edit-indicator').style.display = 'none';
    document.getElementById('save-btn').innerText = "Save & Clear Dashboard";
    document.querySelectorAll('input').forEach(i => i.value = '');
  }

  function editDay(date) {
    const entry = history.find(h => h.date === date);
    if (!entry) return;
    currentlyEditingDate = date;
    document.getElementById('edit-date-label').innerText = date;
    document.getElementById('edit-indicator').style.display = 'block';
    document.getElementById('save-btn').innerText = "Update History Entry";

    for (let id in entry.details) {
      const el = document.getElementById(id);
      if (el) el.value = entry.details[id];
    }
    window.scrollTo({ top: 0, behavior: 'smooth' });
    runCalc();
  }

  function renderHist() {
    const log = document.getElementById('history-log');
    log.innerHTML = history.length ? '' : '<div style="text-align:center; padding:20px; color:#555; font-size:12px;">No records yet</div>';
    
    history.slice().sort((a,b) => {
        const d1 = a.date.split('/').reverse().join('');
        const d2 = b.date.split('/').reverse().join('');
        return d2.localeCompare(d1);
    }).forEach((h) => {
      log.innerHTML += `
        <div class="history-item">
          <span style="color:#aaa">${h.date}</span>
          <span style="color:var(--income-green)">${h.inc.toLocaleString()}</span>
          <span style="color:var(--expense-red)">${h.exp.toLocaleString()}</span>
          <span style="font-weight:bold">${h.bal.toLocaleString()}</span>
          <span style="text-align:right">
            <button class="action-btn edit-btn" onclick="editDay('${h.date}')">✎</button>
          </span>
        </div>`;
    });
  }

  function hardReset() {
    if(confirm("Permanently erase all history?")) {
      localStorage.clear();
      location.reload();
    }
  }

  async function shareData() {
    let csv = "Date,Income,Expense,Balance\n";
    history.forEach(h => csv += `${h.date},${h.inc},${h.exp},${h.bal}\n`);
    const file = new File([new Blob([csv], { type: 'text/csv' })], 'household_finance.csv', { type: 'text/csv' });

    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      try { await navigator.share({ files: [file], title: 'Finance Report' }); } catch (e) {}
    } else {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv]));
      a.download = 'household_finance.csv';
      a.click();
    }
  }

  init();
</script>
</body>
</html>